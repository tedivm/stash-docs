<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
  
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Invalidation &mdash; Stash 0.12.1 documentation</title>
    
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.12.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Stash 0.12.1 documentation" href="index.html" />
    <link rel="next" title="Core API" href="API.html" />
    <link rel="prev" title="Groupings" href="Grouping.html" />
  
   

  </head>
  <body>
<nav class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="visible-md visible-lg navbar-text pull-right" id="github-stars">
      <iframe src="http://ghbtns.com/github-btn.html?user=tedivm&repo=stash&type=watch&count=true&size=small"
      allowtransparency="true" frameborder="0" scrolling="0" width="110px" height="20px"></iframe>
    </div>
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#toggle-main-nav">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="
    
      index.html">Stash</a>
    </div>
    <div class="collapse navbar-collapse" id="toggle-main-nav">
      <ul class="nav navbar-nav">
          <li><a href="
      index.html">Home</a></li>
          <li><a href="https://github.com/tedivm/stash">Github</a></li>
            
              <li><a href="http://blog.tedivm.com">Blog</a></li>
            
        
      </ul>
    </div>
  </div>
</nav>


    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="API.html" title="Core API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Grouping.html" title="Groupings"
             accesskey="P">previous</a> |</li>
        <li><a href="Contents.html">Stash 0.12.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="container-wrapper">
        <div class="container-fluid">
            
    <div class="top-links">
      <ul class="breadcrumb pull-right">
        <li>
          <a href="Grouping.html" title="previous chapter (use the left arrow)">&larr; Groupings</a>
          <span class="divider"></span>
          
        </li>
          <li><a href="API.html" title="next chapter (use the right arrow)">Core API &rarr;</a></li>
      </ul>
    </div>
  
            <div class="row document clearer">
  <div class="col-md-3 sphinxsidebar">
    <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="
      index.html">
          <img class="logo" src="_static/tedivmGlider.png" alt="Logo"/>
        </a></p>
<div class="panel panel-default">
  <div class="panel-heading">
    <h3><a href="
    
      index.html">Table Of Contents</a></h3>
  </div>
  <div class="panel-body panel-toc panel-globaltoc">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Stash</a></li>
<li class="toctree-l1"><a class="reference internal" href="Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="Basics.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Grouping.html">Groupings</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Invalidation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dog-pile-effect">Dog Pile Effect</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stampede-protection">Stampede Protection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#invalidation-methods">Invalidation Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#precompute">Precompute</a></li>
<li class="toctree-l3"><a class="reference internal" href="#none">None</a></li>
<li class="toctree-l3"><a class="reference internal" href="#old">Old</a></li>
<li class="toctree-l3"><a class="reference internal" href="#value">Value</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sleep">Sleep</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="API.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="Drivers.html">Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="Integration.html">Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extending.html">Extending</a></li>
<li class="toctree-l1"><a class="reference internal" href="AddingDrivers.html">Adding Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contributing.html">Contributing</a></li>
</ul>

  </div>
</div>
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Search</h3>
  </div>
  <div class="panel-body">
    <form class="form-inline" action="search.html" method="get" role="form">
      <div class="input-group">
        <input name="q" type="text" class="form-control">
        <span class="input-group-btn">
          <button class="btn btn-default" type="button">Go</button>
        </span>
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
    </div>
  </div>
                <div class="col-md-9 body">
                  
  <div class="section" id="invalidation">
<span id="id1"></span><h1>Invalidation<a class="headerlink" href="#invalidation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="dog-pile-effect">
<h2>Dog Pile Effect<a class="headerlink" href="#dog-pile-effect" title="Permalink to this headline">¶</a></h2>
<p>The common method for dealing with a cache miss is pretty straight forward- when the cache is checked for a value and it
is stale or not present the value is regenerated. The flaw to this approach is that it can mean many different requests
will see that cache miss at the same time and also attempt to regenerate the potentially expensive code. This in turn
can use up system resources and even cause a cache stampede, which is a type of cascading failure where the system is
placed under too much load to regenerate the cache which causes the load to further increase as more requests for the
data are made.</p>
<p>A good example of this is Javascript Minification. Minifying javascript is an expensive process, and for larger
libraries can take a few seconds to occur (lets say five for this example). If a server receiving 30 requests a second
for a javascript file that is hidden behind a minifier and there is a cache miss then there will be 30 requests the
first second, 60 requests generating it the second, 90 the third, and ultimately by the fifth second there will be 150
different requests regenerating the data. Unfortunately by this point the system load will also have risen considerably,
making that five second processing time rise to higher and higher numbers.</p>
</div>
<div class="section" id="stampede-protection">
<h2>Stampede Protection<a class="headerlink" href="#stampede-protection" title="Permalink to this headline">¶</a></h2>
<p>Stash refers to it's methods for preventing the Dog Pile Effect as Stampede Protection. These features are all ways to
deal with stale data in such a way that only one request has to regenerate it. The default method is by triggering a
single cache miss in advance so that a single process will regenerate the data before the data actually expires. There
are other methods as well, such as reusing old values or simply disabling Stampede Protection altogether.</p>
<p>Defining which method to use done by passing an Invalidation constant to the Item-&gt;get() class when it retrieves it's
value. This tells the Item class how it should handle a miss, and what it should do while another class is processing
data.</p>
<p>The example below tells the Item class that it should switch from the default method of precomputing a value before it
expires and that it should instead wait until the expiration and continue using stale values while another process
regenerates the data.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
    <span class="nv">$item</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getItem</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">);</span>

<span class="c1">// Get the data from the cache using the &quot;Invalidation::OLD&quot; technique for</span>
<span class="c1">// dealing with stampedes</span>
<span class="nv">$userInfo</span> <span class="o">=</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Stash\Invalidation</span><span class="o">::</span><span class="na">OLD</span><span class="p">);</span>

<span class="c1">// Check to see if the cache missed, which could mean that it either didn&#39;t</span>
<span class="c1">// exist or was stale. If another process is regenerating this value and</span>
<span class="c1">// there is a stored value available then this function will return a hit.</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">())</span>
<span class="p">{</span>
    <span class="c1">// Mark this instance as the one regenerating the cache. Because our</span>
    <span class="c1">// protection method is Invalidation::OLD other Stash instances will</span>
    <span class="c1">// use the old value and count it as a hit.</span>
    <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">lock</span><span class="p">();</span>

    <span class="c1">// Run the relatively expensive code.</span>
    <span class="nv">$userInfo</span> <span class="o">=</span> <span class="nx">loadUserInfoFromDatabase</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="c1">// Store the expensive code so the next time it doesn&#39;t miss. The store</span>
    <span class="c1">// function marks the stampede as over for now, so other Stash items</span>
    <span class="c1">// will begin working as normal.</span>
    <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$userInfo</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="invalidation-methods">
<h2>Invalidation Methods<a class="headerlink" href="#invalidation-methods" title="Permalink to this headline">¶</a></h2>
<p>Stash's stampede protection gives developers multiple ways to deal with stale data. Old values can be reused, new values
set, or the cache can even be refreshed before it gets stale. Different methods can be set by passing the appropriate
constant to the Item::get function.</p>
<div class="section" id="precompute">
<h3>Precompute<a class="headerlink" href="#precompute" title="Permalink to this headline">¶</a></h3>
<p>The default behavior of Stash, this method causes Stash to recalculate the cached item <em>before</em> it misses. This reduces
cache misses down to almost zero, as the only ones that occur are for new data or the arterial ones this creates.</p>
<p>When this method is used Item-&gt;get takes one additional argument, the amount of time (in seconds) before the expiration
when it should regenerate the cache. If this isn't pass a default is chosen of 10% of the Item's TTL</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// five minutes before the cache expires one instance will return a miss,</span>
<span class="c1">// causing the cache to regenerate.</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Invalidation</span><span class="o">::</span><span class="na">PRECOMPUTE</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="none">
<h3>None<a class="headerlink" href="#none" title="Permalink to this headline">¶</a></h3>
<p>This removes stampede protection and provides no special behavior to limit multiple multiple cache misses. When a value
is stale isMiss will always return true. This is useful for code that has special behavior on misses or that does not
get called by a large number of users, such as by the Session Handler. Before Stash v0.12 this was the default behavior.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Invalidation</span><span class="o">::</span><span class="na">NONE</span><span class="p">);</span>

<span class="c1">// returns false if the item is missing or expired, no exceptions.</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="old">
<h3>Old<a class="headerlink" href="#old" title="Permalink to this headline">¶</a></h3>
<p>When this method is enabled and a different instance has called the lock function, Stash will return the existing value
in the cache even if it is stale.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Invalidation</span><span class="o">::</span><span class="na">OLD</span><span class="p">);</span>

<span class="c1">// return false if another Item instance is rebuilding the cached item even</span>
<span class="c1">// though the returned item is stale</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="value">
<h3>Value<a class="headerlink" href="#value" title="Permalink to this headline">¶</a></h3>
<p>When this method is enabled and a different instance has called the lock function Stash will return the supplied value.</p>
<p>This method takes one additional argument, the value to be returned while stampede protection is on.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">SP_VALUE</span><span class="p">,</span> <span class="s1">&#39;Use this value while regenerating cache.&#39;</span><span class="p">);</span>

<span class="c1">// returns true only if the value is stale and no other processes have</span>
<span class="c1">// stated rebuilding the value.</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="sleep">
<h3>Sleep<a class="headerlink" href="#sleep" title="Permalink to this headline">¶</a></h3>
<p>When this method is enabled and a different instance has called the lock function Stash will sleep and attempt to load
the value upon waking up. This is not a website friendly method, but is potentially useful for cli or long running
scripts.</p>
<p>When this method is used Stash-&gt;get takes two additional arguments, the time (in microseconds) to sleep before
reattempting to load the cache and the amount of times to try and reload it before giving up. The maximum amount of time
spent sleeping is the product of these two numbers.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// sleeps for .5 seconds, reattempts to load the cache, then sleeps again</span>
<span class="c1">// for another .5 seconds before making it&#39;s last attempt</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Invalidation</span><span class="o">::</span><span class="na">SLEEP</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>


                </div>
              <div class="clearfix"></div>
            </div>
            
    <div class="footer-links">
      <ul class="breadcrumb pull-right">
        <li>
          <a href="Grouping.html" title="previous chapter (use the left arrow)">&larr; Groupings</a>
          <span class="divider"></span>
          
        </li>
          <li><a href="API.html" title="next chapter (use the right arrow)">Core API &rarr;</a></li>
      </ul>
    </div>
  

        </div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="API.html" title="Core API"
             >next</a> |</li>
        <li class="right" >
          <a href="Grouping.html" title="Groupings"
             >previous</a> |</li>
        <li><a href="Contents.html">Stash 0.12.1 documentation</a> &raquo;</li> 
      </ul>
    </div>

  <script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer container">
    &copy; Copyright 2014, Robert Hafner. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29779027-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>