<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
  
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Invalidation &mdash; Stash 0.12.1 documentation</title>
    
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.12.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Stash 0.12.1 documentation" href="index.html" />
    <link rel="next" title="Core API" href="API.html" />
    <link rel="prev" title="Groupings" href="Grouping.html" />
  
   

  </head>
  <body>
<nav class="navbar navbar-default navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="visible-md visible-lg navbar-text pull-right" id="github-stars">
      <iframe src="http://ghbtns.com/github-btn.html?user=tedivm&repo=stash&type=watch&count=true&size=small"
      allowtransparency="true" frameborder="0" scrolling="0" width="110px" height="20px"></iframe>
    </div>
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#toggle-main-nav">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="
    
      index.html">Stash</a>
    </div>
    <div class="collapse navbar-collapse" id="toggle-main-nav">
      <ul class="nav navbar-nav">
          <li><a href="
      index.html">Home</a></li>
          <li><a href="https://github.com/tedivm/stash">Github</a></li>
            
              <li><a href="http://blog.tedivm.com">Blog</a></li>
            
        
      </ul>
    </div>
  </div>
</nav>


    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="API.html" title="Core API"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Grouping.html" title="Groupings"
             accesskey="P">previous</a> |</li>
        <li><a href="Contents.html">Stash 0.12.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="container-wrapper">
        <div class="container-fluid">
            
    <div class="top-links">
      <ul class="breadcrumb pull-right">
        <li>
          <a href="Grouping.html" title="previous chapter (use the left arrow)">&larr; Groupings</a>
          <span class="divider"></span>
          
        </li>
          <li><a href="API.html" title="next chapter (use the right arrow)">Core API &rarr;</a></li>
      </ul>
    </div>
  
            <div class="row document clearer">
  <div class="col-md-3 sphinxsidebar">
    <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="
      index.html">
          <img class="logo" src="_static/tedivmGlider.png" alt="Logo"/>
        </a></p>
<div class="panel panel-default">
  <div class="panel-heading">
    <h3><a href="
    
      index.html">Table Of Contents</a></h3>
  </div>
  <div class="panel-body panel-toc panel-globaltoc">
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Stash</a></li>
<li class="toctree-l1"><a class="reference internal" href="Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="Basics.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Grouping.html">Groupings</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Invalidation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#stampede-protection">Stampede Protection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#invalidation-methods">Invalidation Methods</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#precompute">Precompute</a></li>
<li class="toctree-l3"><a class="reference internal" href="#none">None</a></li>
<li class="toctree-l3"><a class="reference internal" href="#old">Old</a></li>
<li class="toctree-l3"><a class="reference internal" href="#value">Value</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sleep">Sleep</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="API.html">Core API</a></li>
<li class="toctree-l1"><a class="reference internal" href="Drivers.html">Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="Integration.html">Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Extending.html">Extending</a></li>
<li class="toctree-l1"><a class="reference internal" href="AddingDrivers.html">Adding Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="Contributing.html">Contributing</a></li>
</ul>

  </div>
</div>
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Search</h3>
  </div>
  <div class="panel-body">
    <form class="form-inline" action="search.html" method="get" role="form">
      <div class="input-group">
        <input name="q" type="text" class="form-control">
        <span class="input-group-btn">
          <button class="btn btn-default" type="button">Go</button>
        </span>
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
  </div>
</div>
    </div>
  </div>
                <div class="col-md-9 body">
                  
  <div class="section" id="invalidation">
<span id="id1"></span><h1>Invalidation<a class="headerlink" href="#invalidation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="stampede-protection">
<h2>Stampede Protection<a class="headerlink" href="#stampede-protection" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, when a cache item expires, multiple requests might come in for that
item before it can be regenerated. If the process of generating it is very slow
or expensive, these requests might stack up, each slowing down the system enough
that previous requests can't complete -- this is a cache stampede. Stash has a
stampede prevention function that's fairly easy to use:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
    <span class="nv">$item</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getItem</span><span class="p">(</span><span class="s1">&#39;Test&#39;</span><span class="p">);</span>

<span class="c1">// Get the data from the cache using the &quot;Item::SP_OLD&quot; technique for</span>
<span class="nx">dealing</span> <span class="nx">with</span> <span class="nx">stampedes</span>
<span class="nv">$userInfo</span> <span class="o">=</span> <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Stash\Item</span><span class="o">::</span><span class="na">SP_OLD</span><span class="p">);</span>

<span class="c1">// Check to see if the cache missed, which could mean that it either didn&#39;t</span>
<span class="nx">exist</span> <span class="k">or</span> <span class="nx">was</span> <span class="nx">stale</span><span class="o">.</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">())</span>
<span class="p">{</span>
    <span class="c1">// Mark this instance as the one regenerating the cache. Because our</span>
    <span class="c1">// protection method is STASH_SP_OLD other Stash instances will use the</span>
    <span class="c1">// old value and count it as a hit.</span>
    <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">lock</span><span class="p">();</span>

    <span class="c1">// Run the relatively expensive code.</span>
    <span class="nv">$userInfo</span> <span class="o">=</span> <span class="nx">loadUserInfoFromDatabase</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

    <span class="c1">// Store the expensive code so the next time it doesn&#39;t miss. The store</span>
    <span class="c1">// function marks the stampede as over for now, so other Stash items</span>
    <span class="c1">// will begin working as normal.</span>
    <span class="nv">$item</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$userInfo</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="invalidation-methods">
<h2>Invalidation Methods<a class="headerlink" href="#invalidation-methods" title="Permalink to this headline">¶</a></h2>
<p>Stash's stampede protection gives developers multiple ways to deal with stale
data. Old values can be reused, new values set, or the cache can even be
refreshed before it gets stale. Different methods can be set by passing the
appropriate constant to Stash's &quot;get&quot; function.</p>
<div class="section" id="precompute">
<h3>Precompute<a class="headerlink" href="#precompute" title="Permalink to this headline">¶</a></h3>
<p>The personal favorite method of the Stash developers, this method causes Stash
to recalculate the cached item _before_ it misses.</p>
<p>When this method is used Stash-&gt;get takes one additional argument, the amount of
time (in seconds) before the expiration when it should regenerate the cache.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// five minutes before the cache expires one instance will return a miss,</span>
<span class="c1">// causing the cache to regenerate.</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">SP_PRECOMPUTE</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="none">
<h3>None<a class="headerlink" href="#none" title="Permalink to this headline">¶</a></h3>
<p>By default Stash simply returns true for the &quot;isMiss&quot; function whenever the
cache is invalid, meaning multiple cache misses can occur at once and stampede
protection is not enabled.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// preserves backward compatibility.</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="c1">// recommended if this method is explicitly wanted as the default value may</span>
<span class="c1">// change in the future.</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">SP_NONE</span><span class="p">);</span>

<span class="c1">// returns false if the item is missing or expired, no exceptions.</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="old">
<h3>Old<a class="headerlink" href="#old" title="Permalink to this headline">¶</a></h3>
<p>When this method is enabled and a different instance has called the lock
function, Stash will return the existing value in the cache even if it is stale.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">SP_OLD</span><span class="p">);</span>

<span class="c1">// return false if another Stash instance is rebuilding the cached item even</span>
<span class="c1">// though the returned item is stale</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="value">
<h3>Value<a class="headerlink" href="#value" title="Permalink to this headline">¶</a></h3>
<p>When this method is enabled and a different instance has called the lock
function Stash will return the supplied value.</p>
<p>This method takes one additional argument, the value to be returned while
stampede protection is on.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">SP_VALUE</span><span class="p">,</span> <span class="s1">&#39;Return this if stampede protection stops a miss&#39;</span><span class="p">);</span>

<span class="c1">// returns true only if the value is stale and no other processes have</span>
<span class="c1">// stated rebuilding the value.</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="sleep">
<h3>Sleep<a class="headerlink" href="#sleep" title="Permalink to this headline">¶</a></h3>
<p>When this method is enabled and a different instance has called the lock
function Stash will sleep and attempt to load the value upon waking up. This is
not a website friendly method, but is potentially useful for cli or long running
scripts.</p>
<p>When this method is used Stash-&gt;get takes two additional arguments, the time (in
microseconds) to sleep before reattempting to load the cache and the amount of
times to try and reload it before giving up. The maximum amount of time spent
sleeping is the product of these two numbers.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// sleeps for .5 seconds, reattempts to load the cache,</span>
<span class="c1">// then sleeps again for another .5 seconds before making it&#39;s last attempt</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nx">Item</span><span class="o">::</span><span class="na">SP_SLEEP</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>


                </div>
              <div class="clearfix"></div>
            </div>
            
    <div class="footer-links">
      <ul class="breadcrumb pull-right">
        <li>
          <a href="Grouping.html" title="previous chapter (use the left arrow)">&larr; Groupings</a>
          <span class="divider"></span>
          
        </li>
          <li><a href="API.html" title="next chapter (use the right arrow)">Core API &rarr;</a></li>
      </ul>
    </div>
  

        </div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="API.html" title="Core API"
             >next</a> |</li>
        <li class="right" >
          <a href="Grouping.html" title="Groupings"
             >previous</a> |</li>
        <li><a href="Contents.html">Stash 0.12.1 documentation</a> &raquo;</li> 
      </ul>
    </div>

  <script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer container">
    &copy; Copyright 2014, Robert Hafner. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-29779027-1']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>