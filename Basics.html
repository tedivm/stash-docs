
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Basic Usage &mdash; Stash 0.10.1-dev documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.10.1-dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="top" title="Stash 0.10.1-dev documentation" href="index.html" />
    <link rel="next" title="Invalidation" href="Invalidation.html" />
    <link rel="prev" title="Stash" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="Invalidation.html" title="Invalidation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Stash"
             accesskey="P">previous</a> |</li>
        <li><a href="Contents.html">Stash 0.10.1-dev documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="basic-usage">
<span id="basics"></span><h1>Basic Usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline">¶</a></h1>
<p>Stash is a simple to use library with powerful features.</p>
<div class="section" id="autoloading">
<h2>Autoloading<a class="headerlink" href="#autoloading" title="Permalink to this headline">¶</a></h2>
<p>The Stash library conforms to the PSR-0 autoloading standard. If your project
doesn&#8217;t already use a PSR-0 compliant autoloader, you can simply include the
<cite>autoload.php</cite> file at the root of the project to load Stash classes.</p>
<p>All of Stash&#8217;s classes live in the Stash namespace.</p>
</div>
<div class="section" id="creating-stash-objects">
<h2>Creating Stash Objects<a class="headerlink" href="#creating-stash-objects" title="Permalink to this headline">¶</a></h2>
<p>Creating a basic Stash object is simple:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$stash</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stash\Pool</span><span class="p">();</span>

<span class="c1">// Set the &quot;key&quot;, which is the path the Stash object points to.</span>
<span class="nv">$item</span> <span class="o">=</span> <span class="nv">$stash</span><span class="o">-&gt;</span><span class="na">getCache</span><span class="p">(</span><span class="s1">&#39;path/to/data&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>This will create a cache object with no cross request storage, meaning the data
will only be cached for the lifetime of that one script or request. In order to
store cache results across requests, we need a driver. Each driver interfaces
with a specific form of persistent storage.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// Create Driver with default options</span>
<span class="nv">$stashFileSystem</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stash\Driver\FileSystem</span><span class="p">();</span>

<span class="c1">// Create the actual cache object, injecting the backend</span>
<span class="nv">$stash</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stash\Pool</span><span class="p">(</span><span class="nv">$stashFileSystem</span><span class="p">);</span>

<span class="c1">// Set the &quot;key&quot;, which is the path the Stash object points to. This will be</span>
<span class="c1">// discussed in depth later, but for now just know it&#39;s an identifier.</span>
<span class="nv">$item</span> <span class="o">=</span> <span class="nv">$stash</span><span class="o">-&gt;</span><span class="na">getItem</span><span class="p">(</span><span class="s1">&#39;path/to/data&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>Each driver object can be used by many different cache objects, so that any
initial setup and overhead (database connections, file drivers, etc.) can be
done only once per request. In order to simplify this process, the Pool class
automates the process of driver creation to ensure that all cache objects use
the same drivers.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// Create Driver with default options</span>
<span class="nv">$stashFileSystem</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stash\Driver\FileSystem</span><span class="p">();</span>

<span class="c1">// Create pool and inject driver</span>
<span class="nv">$pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stash\Pool</span><span class="p">(</span><span class="nv">$stashFileSystem</span><span class="p">);</span>

<span class="c1">// Retrieve a single cache item</span>
<span class="nv">$item</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getItem</span><span class="p">(</span><span class="s1">&#39;path/to/data&#39;</span><span class="p">);</span>

<span class="c1">// Retrieve an iterator containing multiple cache items</span>
<span class="nv">$items</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getItemIterator</span><span class="p">(</span><span class="s1">&#39;path/to/data&#39;</span><span class="p">,</span> <span class="s1">&#39;path/to/more/data&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="identifying-items-using-keys">
<h2>Identifying Items Using Keys<a class="headerlink" href="#identifying-items-using-keys" title="Permalink to this headline">¶</a></h2>
<p>Stash identifies items in the cache pool using keys, which are just simple
strings. Stash has a special kind of grouping system that allow cache items to
be nested, similar to how folders are nested in filesystems, by adding a slash
to Keys. The slash tells the Implementing Library where the nesting points are.
If no nesting is used, Stacks behave exactly like the standard Cache interfaces.
Nesting allows developers to organize items just like they would files and
folders on a computer. This makes clearing groups of items in the cache as
simple as clearing their parent node, just like deleting a directory would erase
all the files underneath.</p>
<p>A project that had different models, each identified by an id and a type, might
have it&#8217;s keys for those models start with models/type/id, with individual
pieces of data stored in keys inside of those. If the user &#8220;bob&#8221; had the id
&#8220;32&#8221;, the path to his data in the cache would be &#8220;models/users/32&#8221;.</p>
<p>Stash accepts keys in two forms: as a slash-delimited string, or as a series of
arguments representing each level of nesting. Both work in exactly the same way.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// Pass the key as a string</span>
<span class="nv">$stashItem</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getItem</span><span class="p">(</span><span class="s1">&#39;models/users/&#39;</span> <span class="o">.</span> <span class="nv">$id</span> <span class="o">.</span> <span class="s1">&#39;/info&#39;</span><span class="p">);</span>

<span class="c1">// Pass the key as a series of arguments</span>
<span class="nv">$stashItem</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getItem</span><span class="p">(</span><span class="s1">&#39;models&#39;</span><span class="p">,</span> <span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="nv">$id</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="storing-and-retrieving-data">
<h2>Storing and Retrieving Data<a class="headerlink" href="#storing-and-retrieving-data" title="Permalink to this headline">¶</a></h2>
<p>Storing data in Stash (and retrieving it in future requests) is easy. Three
functions do the bulk of the work:</p>
<ul class="simple">
<li><em>get()</em> - Returns data that was previously stored, or null if nothing stored.
(Since it is possible to store null values it is very important not to rely on a
null return to check for a cache miss.)</li>
<li><em>isMiss()</em> - Returns true if no data is stored or the data is stale; returns
false if fresh data is present.</li>
<li><em>store($data, $expiration = null)</em> - Stores the specified data in the driver&#8217;s
persistent storage.</li>
</ul>
<p>Using these three functions, you can create simple cache blocks &#8211; pieces of
code where you fetch data, check to see if it&#8217;s fresh, and then regenerate and
store the data if it was stale or absent.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Get cache item.</span>
    <span class="nv">$stashItem</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getItem</span><span class="p">(</span><span class="s1">&#39;path/to/item&#39;</span><span class="p">);</span>

<span class="c1">// Attempt to &quot;get&quot;</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>

<span class="c1">// Check to see if the data was a miss.</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">())</span>
<span class="p">{</span>
    <span class="c1">// Run intensive code</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">codeThatTakesALongTime</span><span class="p">();</span>

    <span class="c1">// Store data.</span>
    <span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Continue as normal.</span>
<span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</pre></div>
</div>
<p>The <em>store</em> function can take the expiration as an additional argument. This
expiration can be a time, in seconds, that the cache should live or it can be a
DateTime object that represents the time the cached item should expire. (This
argument can be negative, which will result in an immediately stale cache.)</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// Get cache item.</span>
    <span class="nv">$stashItem</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getItem</span><span class="p">(</span><span class="s1">&#39;path/to/item&#39;</span><span class="p">);</span>

<span class="c1">// Using an age.</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nv">$stash</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">())</span>
<span class="p">{</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">expensiveFunction</span><span class="p">();</span>
    <span class="c1">// Cache expires in one hour.</span>
    <span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mi">3600</span><span class="p">);</span>
<span class="p">}</span>


<span class="c1">// Using a DateTime.</span>
<span class="nv">$data</span> <span class="o">=</span> <span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
<span class="k">if</span><span class="p">(</span><span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">isMiss</span><span class="p">())</span>
<span class="p">{</span>
    <span class="nv">$data</span> <span class="o">=</span> <span class="nx">expensiveFunction</span><span class="p">();</span>

    <span class="c1">// Cache expires January 21, 2012.</span>
    <span class="nv">$expiration</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DateTime</span><span class="p">(</span><span class="s1">&#39;2012-01-21&#39;</span><span class="p">);</span>
    <span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$expiration</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The expiration sets the <em>maximum</em> time a cached object can remain fresh. In
order to distribute cache misses, the Stash system tries to vary the expiration
time for items by shortening a random amount; some drivers may also have size
restrictions or other criteria for removing items early, and items can be
cleared manually before they expire. Items will never be reported as fresh
<em>after</em> the expiration time passes, however.</p>
</div>
<div class="section" id="clearing-data">
<h2>Clearing Data<a class="headerlink" href="#clearing-data" title="Permalink to this headline">¶</a></h2>
<p>Clearing data is just as simple as getting it. As with the <em>get</em> and <em>store</em>
functions, the <em>clear</em> function takes a set key - if one isn&#8217;t set then the
entire cache is cleared. Note that clearing a key will clear that key <em>and any
keys beneath it in the hierarchy.</em></p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// Clearing a key.</span>
<span class="nv">$stashItem</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getCache</span><span class="p">(</span><span class="s1">&#39;path/to/data/specific/123&#39;</span><span class="p">)</span>
<span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">clear</span><span class="p">();</span>

<span class="c1">// Clearing a key with subkeys</span>
<span class="nv">$stashItem</span> <span class="o">=</span> <span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">getCache</span><span class="p">(</span><span class="s1">&#39;path/to/data/general&#39;</span><span class="p">)</span> <span class="c1">// clears &#39;path/to/data/*&#39;</span>
<span class="nv">$stashItem</span><span class="o">-&gt;</span><span class="na">clear</span><span class="p">();</span>
</pre></div>
</div>
<p>The Pool class can also empty the entire cache:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="purging-data">
<h2>Purging Data<a class="headerlink" href="#purging-data" title="Permalink to this headline">¶</a></h2>
<p>The <em>purge</em> function removes stale data from the cache backends while leaving
current data intact. Depending on the size of the cache and the specific drivers
in use this can take some time, so it is best called as part of a separate
maintenance task or as part of a cron job.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$pool</span><span class="o">-&gt;</span><span class="na">purge</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="Contents.html">
              <img class="logo" src="_static/tedivmGlider.png" alt="Logo"/>
            </a></p>
<h3><a href="Contents.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Stash</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Basic Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#autoloading">Autoloading</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-stash-objects">Creating Stash Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#identifying-items-using-keys">Identifying Items Using Keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="#storing-and-retrieving-data">Storing and Retrieving Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#clearing-data">Clearing Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#purging-data">Purging Data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Invalidation.html">Invalidation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Classes.html">Core Classes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Drivers.html">Drivers</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/Basics.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="Invalidation.html" title="Invalidation"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Stash"
             >previous</a> |</li>
        <li><a href="Contents.html">Stash 0.10.1-dev documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Robert Hafner.
      Last updated on Nov 24, 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>